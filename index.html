<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text to XML Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        textarea {
            width: 100%;
            height: 200px;
            margin-bottom: 10px;
        }
        input {
            margin-bottom: 10px;
            padding: 5px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1>Text to XML Converter</h1>
    <textarea id="inputText" placeholder="Paste your text here..."></textarea>
    <br>
    <label for="masterGain">Master Gain (integer):</label>
    <input type="number" id="masterGain" placeholder="-2">
    <br>
    <label for="styleName">Style Name (max 36 chars):</label>
    <input type="text" id="styleName" maxlength="36" placeholder="调音名称，上限36字符">
    <br>
    <label for="description">Description (max 140 chars):</label>
    <input type="text" id="description" maxlength="140" placeholder="调音描述，上限140字符">
    <br>
    <button onclick="convertToXML()">Convert</button>
    <button onclick="downloadXML()">Download</button>
    <h2>Generated XML:</h2>
    <pre id="outputXML"></pre>

    <script>
        function getCurrentTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const date = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}${month}${date}_${hours}${minutes}${seconds}`;
        }

        function convertToXML() {
            const inputText = document.getElementById('inputText').value;
            const masterGain = document.getElementById('masterGain').value || -2;
            let styleName = document.getElementById('styleName').value.trim();
            let description = document.getElementById('description').value.trim();

            const timestamp = getCurrentTimestamp();

            if (!styleName) {
                styleName = `未命名调音_${timestamp}`;
            }
            if (!description) {
                const now = new Date();
                const formattedDate = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()} ${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
                description = `未命名调音_${formattedDate}`;
            }

            const lines = inputText.split('\n');
            const eqList = [];

            for (let i = 2; i < 12; i++) { // Extract channels 1 to 10
                const columns = lines[i]?.split('\t');
                if (!columns || columns.length < 5) continue;

                const type = columns[3]?.trim();
                const freq = parseFloat(columns[4]) || (i - 2) * 10;
                const gain = parseFloat(columns[5]) || 0;
                const q = parseFloat(columns[6]) || 1;

                let typeCode = 0; // Default type
                if (type === 'PK') typeCode = 0;
                else if (type === 'LS_Q') typeCode = 1;
                else if (type === 'HS_Q') typeCode = 2;

                eqList.push(`        <eq index="${i - 2}">
          <param name="type">${typeCode}</param>
          <param name="freq">${freq}</param>
          <param name="gain">${gain}</param>
          <param name="q">${q}</param>
        </eq>`);
            }

            const xml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<FiiO_DSP model="FIIO BTR13" version="0.0.1">
<!-- Generated by 嗜金水狙 ShuiJu's BTR13 REW EQ converter, tested for FIIO BTR13 EQ xml file, version 0.0.1, REW V5.31.3 -->
  <module name="EQ">
    <eqGroup>
      <param name="masterGain">${masterGain}</param>
      <eqList>
${eqList.join('\n')}
      </eqList>
    </eqGroup>
  </module>
  <styleName>${styleName}</styleName>
  <description>${description}</description>
</FiiO_DSP>`;

            document.getElementById('outputXML').textContent = xml;
        }

        function downloadXML() {
            let styleName = document.getElementById('styleName').value.trim();
            const timestamp = getCurrentTimestamp();
            if (!styleName) {
                styleName = `未命名调音_${timestamp}`;
            }

            const xmlContent = document.getElementById('outputXML').textContent;
            const blob = new Blob([xmlContent], { type: 'application/xml' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${styleName}.xml`;
            link.click();
        }
    </script>
</body>
</html>
